<!doctype html>
<html lang="de">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Entnahme buchen</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<body style="font-family: system-ui; max-width: 520px; margin: 24px auto;">
  <h1>Entnahme</h1>
  <p>Scan-Flow: QR kann optional <code>?item=&lt;ITEM_UUID&gt;</code> übergeben.</p>
  <label>ID (z.B. MAX23)
    <input id="displayId" placeholder="Deine ID" style="width:100%;padding:8px" />
  </label>
  <div id="items" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px"></div>
  <div style="margin-top:12px">
    <label>Menge <input id="qty" type="number" min="1" value="1" style="width:80px" /></label>
  </div>
  <button id="book" style="margin-top:12px;padding:10px 14px">Buchen</button>
  <div id="msg" style="margin-top:12px"></div>

<script>
  const url = 'YOUR_SUPABASE_URL';
  const anon = 'YOUR_ANON_KEY';
  const supabase = window.supabase.createClient(url, anon);
  let selectedItemId = null;

  async function loadItems() {
    const { data, error } = await supabase.rpc('list_active_items');
    if (error) { document.getElementById('msg').textContent = error.message; return; }
    const grid = document.getElementById('items');
    const params = new URLSearchParams(location.search);
    const pre = params.get('item'); // optional item-id aus QR

    data.forEach(it => {
      const btn = document.createElement('button');
      btn.textContent = `${it.name} — ${(it.price_cents/100).toFixed(2)} €`;
      btn.style.padding = '10px';
      btn.style.border = '1px solid #ccc';
      btn.style.borderRadius = '8px';
      btn.onclick = () => { selectedItemId = it.id; highlight(btn); };
      grid.appendChild(btn);
      if (pre && pre === it.id) { selectedItemId = it.id; highlight(btn); }
    });
  }
  function highlight(btn){
    [...document.querySelectorAll('#items button')].forEach(b=>b.style.outline='none');
    btn.style.outline = '3px solid #999';
  }

  document.getElementById('book').onclick = async () => {
    const displayId = document.getElementById('displayId').value.trim();
    const qty = Math.max(1, parseInt(document.getElementById('qty').value||'1',10));
    if (!displayId || !selectedItemId) { document.getElementById('msg').textContent = 'Bitte ID und Artikel wählen.'; return; }
    const { data, error } = await supabase.rpc('book_transaction', { _display_id: displayId, _item_id: selectedItemId, _qty: qty, _by: 'web' });
    if (error) { document.getElementById('msg').textContent = error.message; return; }
    const bal = data && data[0] ? data[0].new_balance_cents : 0;
    document.getElementById('msg').textContent = `Danke! Gebucht. Aktueller Stand: ${(bal/100).toFixed(2)} €`;
  };

  loadItems();
</script>
</body>
</html>
